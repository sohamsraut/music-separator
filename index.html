<!-- Client Side Code -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Music Separator</title>
  </head>
  <body>
    <h1>Upload a song here</h1>
    <p>
      This app allows you to upload a song and separate it into its components (or "stems") such as
      instrumental, vocals, drums, bass, etc. These separated stems are then available to play or download.
    </p>
    <input type="file" id="fileInput"><br><br>

    <label for="stems">Choose number of stems:</label>
    <select id="stems">
        <option value="2">2 (Vocals + Instrumental)</option>
        <option value="4" selected>4 (Vocals + Drums + Bass + Other)</option>
        <option value="5">5 (Vocals + Drums + Bass + Piano + Other)</option>
    </select><br><br>

    <button onclick="uploadFile()">Separate</button>
    <p id="status"></p>

    <!-- Play controls -->
    <div id="controls" style="display:none; margin-bottom: 15px;">
      <button id="play-all">Play All</button>
      <button id="pause-all">Pause All</button>
    </div>

    <div id="players"></div>

    <script>
        let stemAudios = []; // store all audio elements

        async function uploadFile() {
            const file = document.getElementById('fileInput').files[0];
            const stems = document.getElementById('stems').value;
            const playersDiv = document.getElementById('players');
            const controlsDiv = document.getElementById('controls');
            playersDiv.innerHTML = '';
            stemAudios = [];
            controlsDiv.style.display = "none";
            document.getElementById('status').innerText = '';

            if (!file) {
                alert("Please choose a file.");
                return;
            }

            document.getElementById('status').innerText = "Processing... Please wait.";

            const formData = new FormData();
            formData.append("file", file);
            formData.append("stems", stems);

            const response = await fetch("http://127.0.0.1:8000/separate", {
                method: "POST",
                body: formData
            });

            if (response.ok && response.status === 200) {
                const data = await response.json();
                if (data.error) {
                    document.getElementById('status').innerText = "Error: " + data.error;
                    return;
                }
                document.getElementById('status').innerText = "Separation complete! Play the stems below:";

                data.stems.forEach(stem => {
                    const container = document.createElement('div');

                    const label = document.createElement('p');
                    label.innerText = stem.name;

                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = stem.url;

                    const downloadBtn = document.createElement('a');
                    downloadBtn.href = stem.url;
                    downloadBtn.download = stem.name + ".wav";
                    downloadBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/>
                        </svg>
                    `;
                    downloadBtn.style.marginLeft = "10px";
                    downloadBtn.style.textDecoration = "none";
                    downloadBtn.style.cursor = "pointer";

                    container.appendChild(label);
                    container.appendChild(audio);
                    container.appendChild(downloadBtn);
                    playersDiv.appendChild(container);
                });

                // Show play controls
                controlsDiv.style.display = "block";
            } else {
                document.getElementById('status').innerText = "Error during processing.";
            }
        }

        document.getElementById("play-all").addEventListener("click", () => {
            stemAudios.forEach(audio => {
                audio.audio.currentTime = 0;
                audio.audio.play();
            });
        });

        document.getElementById("pause-all").addEventListener("click", () => {
            stemAudios.forEach(audio => audio.pause());
        });
    </script>
  </body>
</html>
