<!-- Client Side Code -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Music Separator</title>
  </head>
  <body>
    <h1>Upload a song here</h1>
    <p>
      This app allows you to upload a song and separate it into its components (or "stems") such as
      instrumental, vocals, drums, bass, etc. These separated stems are then available to play or download.
    </p>
    <input type="file" id="fileInput"><br><br>

    <label for="stems">Choose number of stems:</label>
    <select id="stems">
        <option value="2">2 (Vocals + Instrumental)</option>
        <option value="4" selected>4 (Vocals + Drums + Bass + Other)</option>
        <option value="5">5 (Vocals + Drums + Bass + Piano + Other)</option>
    </select><br><br>

    <button onclick="uploadFile()">Separate</button>
    <p id="status"></p>

    <!-- Play controls -->
    <div id="controls" style="display:none; margin-bottom: 15px;">
      <button id="play-all">Play All</button>
      <button id="pause-all">Pause All</button>
    </div>

    <div id="players"></div>

    <script>
      async function uploadFile() {
          const file = document.getElementById('fileInput').files[0];
          const stems = document.getElementById('stems').value;
          const playersDiv = document.getElementById('players');
          playersDiv.innerHTML = '';
          document.getElementById('status').innerText = '';

          if (!file) {
              alert("Please choose a file.");
              return;
          }

          document.getElementById('status').innerText = "Processing... Please wait.";

          const formData = new FormData();
          formData.append("file", file);
          formData.append("stems", stems);

          const response = await fetch("http://127.0.0.1:8000/separate", {
              method: "POST",
              body: formData
          });

          if (response.ok && response.status === 200) {
              const data = await response.json();
              if (data.error) {
                  document.getElementById('status').innerText = "Error: " + data.error;
                  return;
              }
              document.getElementById('status').innerText = "Separation complete!";

              // Create Play All button
              const playAllBtn = document.createElement('button');
              playAllBtn.innerText = "▶ Play All";
              playAllBtn.onclick = () => {
                  const audios = document.querySelectorAll('#players audio');
                  audios.forEach(a => {
                      a.currentTime = 0; // start from beginning
                      a.play();
                  });
              };
              playersDiv.appendChild(playAllBtn);

              // Create Pause All button
              const pauseAllBtn = document.createElement('button');
              pauseAllBtn.innerText = "⏸ Pause All";
              pauseAllBtn.onclick = () => {
                  const audios = document.querySelectorAll('#players audio');
                  audios.forEach(a => a.pause());
              };
              playersDiv.appendChild(pauseAllBtn);

              // Add each stem with audio + download
              data.stems.forEach(stem => {
                  const container = document.createElement('div');

                  const label = document.createElement('p');
                  label.innerText = stem.name;

                  const audio = document.createElement('audio');
                  audio.controls = true;
                  audio.src = stem.url;

                  const downloadBtn = document.createElement('a');
                  downloadBtn.href = stem.url;
                  downloadBtn.download = stem.name + ".wav";
                  downloadBtn.innerHTML = "⬇️";
                  downloadBtn.title = "Download";
                  downloadBtn.style.marginLeft = "10px";
                  downloadBtn.style.fontSize = "20px";
                  downloadBtn.style.cursor = "pointer";

                  container.appendChild(label);
                  container.appendChild(audio);
                  container.appendChild(downloadBtn);
                  playersDiv.appendChild(container);
              });
          } else {
              document.getElementById('status').innerText = "Error during processing.";
          }
      }
    </script>
  </body>
</html>
